name: CI
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    name: tests & lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version-file: .python-version

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcairo2-dev pkg-config

    - name: Sync deps
      run: uv sync --all-extras

    - name: Ruff lint
      run: uv run ruff check .

    - name: Ruff format (check)
      run: uv run ruff format --check .

    - name: Pyright
      run: uv run pyright

    - name: Pytest
      id: pytest
      run: uv run pytest --cov=src --cov-report=term-missing --cov-report=xml

    - name: Upload coverage
      uses: codecov/codecov-action@v5
      if: always() && steps.pytest.outcome != 'skipped'
      with:
        files: ./coverage.xml
        use_oidc: true
        fail_ci_if_error: false
