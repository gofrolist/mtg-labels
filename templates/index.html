<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MTG Printable Label Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  <link rel="apple-touch-icon" href="/static/favicon.svg" />

  <!-- Bootstrap 5.3.3 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Bootstrap Icons (optional but recommended for icons) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <style>
    /* CSS custom properties for consistent theming */
    :root {
      --mtg-bg: #f8f9fa;
      --mtg-card-bg: #ffffff;
      --mtg-text: #212529;
      --mtg-text-muted: #6c757d;
      --mtg-border: #dee2e6;
      --mtg-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* Dark mode theme variables */
    [data-theme="dark"] {
      --mtg-bg: #121212;
      --mtg-card-bg: #1e1e1e;
      --mtg-text: #e0e0e0;
      --mtg-text-muted: #9e9e9e;
      --mtg-border: #333333;
      --mtg-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    body {
      background-color: var(--mtg-bg);
      color: var(--mtg-text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Symbol images: 20x20, with a small right margin */
    .set-item img {
      width: 20px;
      height: 20px;
      margin-right: 4px;
    }

    /* Make set icons white in dark mode - same size as light theme */
    [data-theme="dark"] .set-item img {
      filter: invert(1);
    }

    /* Make navbar sticky (always visible) */
    .navbar {
      z-index: 1030; /* ensure it stays above other elements */
      overflow-x: visible;
    }

    /* Prevent navbar from overflowing - desktop only */
    .navbar .container-fluid {
      display: flex;
      align-items: center;
      min-width: 0; /* Allow flex items to shrink below content size */
      width: 100%;
      max-width: 100%;
      overflow: visible;
    }

    @media (min-width: 992px) {
      .navbar .container-fluid {
        flex-wrap: nowrap !important;
      }
    }

    @media (max-width: 991.98px) {
      .navbar .container-fluid {
        flex-wrap: wrap;
      }
    }

    /* Allow navbar brand to shrink on smaller screens */
    .navbar-brand {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
      flex-shrink: 0;
    }

    /* Search input group - fixed width to prevent size changes */
    #navbarSupportedContent .input-group {
      width: 250px;
      position: relative;
      flex-shrink: 0;
    }

    /* Ensure navbar collapse container doesn't overflow */
    .navbar-collapse {
      flex-basis: auto;
      flex-grow: 1;
      min-width: 0;
      overflow: visible;
    }

    /* Prevent navbar collapse from wrapping - desktop only */
    @media (min-width: 992px) {
      .navbar-collapse.show,
      .navbar-collapse.collapsing {
        flex-wrap: nowrap;
      }
    }


    /* Ensure all navbar buttons have consistent alignment */
    #navbarSupportedContent .btn {
      display: inline-flex;
      align-items: center;
      vertical-align: middle;
    }

    /* Ensure template dropdown button matches height of other buttons */
    #templateDropdown {
      display: inline-flex;
      align-items: center;
      vertical-align: middle;
    }

    /* Ensure the right-aligned container aligns items properly - desktop only */
    @media (min-width: 992px) {
      #navbarSupportedContent .ms-auto {
        display: flex;
        align-items: center;
        flex-wrap: nowrap !important;
        flex-shrink: 0;
        min-width: 0;
      }
    }

    /* Allow template dropdown to shrink more aggressively */
    #navbarSupportedContent .dropdown.me-3 {
      flex-shrink: 1;
      min-width: 0;
      max-width: 300px;
    }

    /* Ensure template dropdown button can shrink */
    #navbarSupportedContent .dropdown.me-3 .btn {
      width: 100%;
      min-width: 0;
    }

    /* Template dropdown button should be able to shrink */
    #templateDropdown {
      display: inline-flex;
      align-items: center;
      vertical-align: middle;
      max-width: 100%;
      overflow: hidden;
    }

    /* Template dropdown text should truncate more aggressively */
    #templateDropdownText {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      max-width: 100%;
    }

    /* Ensure dropdown container is positioned relatively */
    #navbarSupportedContent .dropdown {
      position: relative;
    }

    /* Make dropdown menu same width as button */
    #templateDropdownMenu {
      width: 100%;
      min-width: 0;
    }

    /* Ensure dropdown menu items don't overflow */
    #templateDropdownMenu .dropdown-item {
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* Allow right-aligned items to shrink on medium screens */
    @media (min-width: 992px) and (max-width: 1200px) {
      /* Reduce search input width on smaller desktop screens */
      #navbarSupportedContent .input-group {
        width: 200px;
      }

      #navbarSupportedContent .ms-auto {
        flex-wrap: nowrap !important;
        gap: 0.5rem;
      }

      /* Make template dropdown shrink more aggressively */
      #navbarSupportedContent .dropdown.me-3 {
        flex-shrink: 1;
        min-width: 120px;
        max-width: 250px;
      }

      #desktop-generate-pdf {
        flex-shrink: 0;
      }

      /* Reduce Select All button min-width */
      #toggle-select-all-global {
        min-width: 120px;
      }
    }

    /* Extra small desktop screens */
    @media (min-width: 992px) and (max-width: 1024px) {
      #navbarSupportedContent .input-group {
        width: 180px;
      }

      /* Make template dropdown even smaller */
      #navbarSupportedContent .dropdown.me-3 {
        max-width: 180px;
      }
    }

    /* Mobile responsive styles */
    @media (max-width: 991.98px) {
      /* Ensure collapsed navbar content aligns properly with container-fluid when shown */
      #navbarSupportedContent {
        padding-left: 0;
        padding-right: 0;
      }

      /* Only apply flex layout when the collapse is shown */
      #navbarSupportedContent.show {
        display: flex !important;
        flex-direction: column !important;
        width: 100%;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      /* Keep search bar and Select All on one line on mobile */
      #navbarSupportedContent .d-flex.ms-3 {
        margin-left: 0 !important;
        margin-right: 0 !important;
        margin-top: 0.5rem;
        margin-bottom: 0 !important;
        width: 100%;
        flex-direction: row !important;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      /* Make search bar flexible on mobile */
      #navbarSupportedContent .input-group {
        flex: 1;
        min-width: 200px;
        position: relative;
        width: auto !important;
      }

      /* Make Select All button auto-width on mobile */
      #toggle-select-all-global {
        white-space: nowrap;
        flex-shrink: 0;
        margin-right: 0 !important;
      }

      /* Stack right-aligned items properly on mobile */
      #navbarSupportedContent .ms-auto {
        margin-left: 0 !important;
        margin-right: 0 !important;
        margin-top: 0 !important;
        width: 100% !important;
        flex-direction: column !important;
        align-items: stretch !important;
        flex-wrap: wrap !important;
        gap: 0.5rem;
      }

      /* Make template dropdown full width on mobile */
      #navbarSupportedContent .dropdown {
        width: 100% !important;
        margin-bottom: 0 !important;
        margin-right: 0 !important;
        position: relative;
        max-width: 100% !important;
        flex-shrink: 0;
      }

      #navbarSupportedContent .dropdown .btn {
        width: 100%;
        text-align: left;
      }

      /* Desktop PDF button hidden on mobile */
      #desktop-generate-pdf {
        display: none !important;
      }

      /* Remove right margin from buttons on mobile */
      #navbarSupportedContent .me-3 {
        margin-right: 0 !important;
      }

      /* Ensure buttons don't overlap */
      #navbarSupportedContent > * {
        margin-bottom: 0.5rem;
      }

      #navbarSupportedContent > *:last-child {
        margin-bottom: 0;
      }
    }

    /* Ensure search icon container has rounded left corners */
    #search-icon {
      border-top-left-radius: 0.375rem !important;
      border-bottom-left-radius: 0.375rem !important;
    }

    /* Add padding to input field to make room for clear button */
    #search {
      padding-right: 2.5rem;
      border-top-right-radius: 0.375rem !important;
      border-bottom-right-radius: 0.375rem !important;
    }

    /* Clear button styling - positioned inside the input field like Google */
    #clear-search {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      padding: 0;
      border: none;
      background: transparent;
      border-radius: 50%;
      width: 1.75rem;
      height: 1.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease, visibility 0.2s ease, background-color 0.2s ease;
      z-index: 10;
      cursor: pointer;
    }

    #clear-search.visible {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    #clear-search:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    #clear-search:active {
      background-color: rgba(0, 0, 0, 0.1);
    }

    #clear-search i {
      font-size: 1rem;
      color: rgba(0, 0, 0, 0.54);
    }

    #clear-search:hover i {
      color: rgba(0, 0, 0, 0.87);
    }

    /* Basic accordion item spacing */
    .accordion-item {
      border: 1px solid #ddd;
      border-radius: 0.25rem;
      margin-bottom: 8px;
    }

    /* Remove blue background from accordion buttons */
    .accordion-button {
      background-color: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0.5rem 1rem;
    }

    .accordion-button:not(.collapsed) {
      background-color: transparent !important;
      color: inherit;
    }

    .accordion-button:focus {
      border-color: transparent;
      box-shadow: none;
    }

    /* Adjust accordion header container */
    .accordion-header {
      border: none;
    }

    /* Truncate long set names on one line with ellipsis */
    .truncate-label {
      display: inline-block;    /* so we can constrain width */
      max-width: 280px;         /* adjust as desired */
      white-space: nowrap;      /* prevent wrapping */
      overflow: hidden;         /* clip overflow */
      text-overflow: ellipsis;  /* show "..." when truncated */
      vertical-align: middle;   /* align with the checkbox icon */
    }

    /* Group toggle button styling */
    .toggle-group {
      min-width: 140px;
    }

    /* Global toggle button styling */
    #toggle-select-all-global {
      min-width: 140px;
    }

    /* PDF button - prevent text wrapping on both desktop and mobile */
    #desktop-generate-pdf,
    #mobile-generate-pdf {
      white-space: nowrap;
      flex-shrink: 0;
      min-width: 80px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 38px; /* Bootstrap default button height */
    }

    /* Ensure navbar items don't overflow on any screen size */
    .navbar-nav,
    .navbar .d-flex {
      min-width: 0;
    }

    /* Allow buttons to shrink if absolutely necessary */
    .navbar .btn {
      min-width: 0;
      overflow: hidden;
    }

    /* Align checkbox + label vertically and add spacing */
    .set-item {
      display: flex;
      align-items: center;
    }
    .set-item .form-check-input {
      margin-right: 8px;
    }

    /* Donate modal styling */
    #donateModal .modal-content {
      border-radius: 0.5rem;
    }

    #donateModal .modal-header {
      display: flex;
      justify-content: center;
      position: relative;
    }

    #donateModal .modal-header .modal-title {
      text-align: center;
    }

    #donateModal .modal-header .btn-close {
      position: absolute;
      right: 1rem;
    }

    #donateModal .modal-body {
      padding: 0.75rem 1.5rem;
    }

    #donateModal .modal-body a {
      color: #0d6efd;
      transition: color 0.2s ease;
    }

    #donateModal .modal-body a:hover {
      color: #0a58ca;
      text-decoration: underline;
    }

    #donateModal .lead {
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Footer styling */
    footer {
      margin-top: auto;
    }

    footer a {
      color: #0d6efd;
      transition: color 0.2s ease;
    }

    footer a:hover {
      color: #0a58ca;
      text-decoration: underline;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Make main content area grow to push footer down */
    body > .container {
      flex: 1 0 auto;
    }

    /* Theme toggle button in navbar */
    .theme-toggle {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 0.375rem;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #fff;
      transition: all 0.2s ease;
      margin-left: 0.5rem;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.5);
    }

    [data-theme="dark"] .navbar {
      background-color: #1a1a2e !important;
    }

    /* Selection counter at top of page */
    .selection-counter-container {
      padding: 0;
      margin-top: 0.25rem;
      margin-bottom: 1rem;
    }

    /* Mobile margins for selection counter */
    @media (max-width: 991.98px) {
      .selection-counter-container .d-flex {
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .selection-counter-container .search-feedback {
        order: 1;
        width: 100%;
      }

      .selection-counter-container .ms-auto {
        order: 2;
        width: 100%;
        justify-content: flex-end;
      }
    }

    .selection-counter {
      background: none;
      color: var(--mtg-text);
      padding: 0;
      border-radius: 0;
      font-weight: 600;
      font-size: 0.875rem;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }

    .selection-counter.empty {
      background: none;
      color: var(--mtg-text-muted);
    }

    /* Search results feedback */
    .search-feedback {
      font-size: 0.875rem;
      color: var(--mtg-text-muted);
      padding: 0.25rem 0;
      min-height: 0;
    }

    .search-feedback:empty {
      display: none;
    }

    .search-feedback.no-results {
      color: #dc3545;
    }

    /* Loading spinner in button */
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-loading .btn-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
      vertical-align: middle;
    }

    .btn-loading .btn-text {
      display: none;
    }

    .btn-loading i {
      display: none;
    }

    /* Center spinner in button when loading */
    .btn-loading {
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Dark mode form controls */
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select,
    [data-theme="dark"] .input-group-text {
      background-color: var(--mtg-card-bg);
      border-color: var(--mtg-border);
      color: var(--mtg-text);
    }

    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .form-select:focus {
      background-color: var(--mtg-card-bg);
      border-color: #0d6efd;
      color: var(--mtg-text);
    }

    [data-theme="dark"] .form-control::placeholder {
      color: var(--mtg-text-muted);
      opacity: 1;
    }

    [data-theme="dark"] .accordion-item {
      background: var(--mtg-card-bg);
      border-color: var(--mtg-border);
    }

    [data-theme="dark"] .accordion-button {
      background: var(--mtg-card-bg) !important;
      color: var(--mtg-text) !important;
    }

    [data-theme="dark"] .accordion-button:not(.collapsed) {
      background: var(--mtg-card-bg) !important;
      color: var(--mtg-text) !important;
    }

    [data-theme="dark"] .accordion-button::after {
      filter: invert(1);
    }

    [data-theme="dark"] .accordion-body {
      background: var(--mtg-card-bg);
      color: var(--mtg-text);
    }

    [data-theme="dark"] footer {
      background: var(--mtg-card-bg) !important;
      border-color: var(--mtg-border) !important;
      color: var(--mtg-text) !important;
    }

    [data-theme="dark"] footer a {
      color: #0d6efd !important;
    }

    [data-theme="dark"] footer a:hover {
      color: #0a58ca !important;
    }

    [data-theme="dark"] .modal-content {
      background: var(--mtg-card-bg);
      color: var(--mtg-text);
    }

    [data-theme="dark"] .modal-header {
      border-color: var(--mtg-border);
    }

    [data-theme="dark"] .btn-close {
      filter: invert(1);
    }


    [data-theme="dark"] .btn-secondary {
      background-color: var(--mtg-card-bg);
      border-color: var(--mtg-border);
      color: var(--mtg-text);
    }

    [data-theme="dark"] .btn-secondary:hover {
      background-color: var(--mtg-border);
      border-color: var(--mtg-border);
      color: var(--mtg-text);
    }

    [data-theme="dark"] .dropdown-menu {
      background: var(--mtg-card-bg);
      border-color: var(--mtg-border);
    }

    [data-theme="dark"] .dropdown-item {
      color: var(--mtg-text);
    }

    [data-theme="dark"] .dropdown-item .text-muted {
      color: var(--mtg-text-muted) !important;
    }

    [data-theme="dark"] .dropdown-item:hover,
    [data-theme="dark"] .dropdown-item:focus {
      background-color: rgba(13, 110, 253, 0.1);
      color: var(--mtg-text);
    }

    [data-theme="dark"] .dropdown-item:hover .text-muted,
    [data-theme="dark"] .dropdown-item:focus .text-muted {
      color: var(--mtg-text-muted) !important;
    }

    [data-theme="dark"] .dropdown-item.active {
      background-color: rgba(13, 110, 253, 0.2);
      color: var(--mtg-text);
    }

    [data-theme="dark"] .dropdown-item.active .text-muted {
      color: var(--mtg-text-muted) !important;
    }

    [data-theme="dark"] .form-check-label {
      color: var(--mtg-text);
    }

    [data-theme="dark"] .set-item {
      background: var(--mtg-card-bg);
      border-color: var(--mtg-border);
      color: var(--mtg-text);
    }

    [data-theme="dark"] .text-muted {
      color: var(--mtg-text-muted) !important;
    }

    [data-theme="dark"] .small {
      color: var(--mtg-text-muted);
    }

    [data-theme="dark"] #clear-search i {
      color: var(--mtg-text-muted);
    }

    [data-theme="dark"] #clear-search:hover i {
      color: var(--mtg-text);
    }
  </style>
</head>
<body>
  <!-- Sticky Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <a class="navbar-brand fw-bold" href="#">
          MTG Labels
        </a>
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode" title="Toggle dark mode">
          <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
      </div>

      <!-- Generate PDF button and hamburger menu - always visible on mobile -->
      <div class="d-flex align-items-center">
        <button
          type="submit"
          class="btn btn-primary d-lg-none me-2"
          form="sets-form"
          id="mobile-generate-pdf"
        >
          <span class="btn-text">
            <i class="bi bi-file-earmark-pdf"></i> PDF
          </span>
        </button>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <!-- Left-aligned items: Search -->
        <div class="d-flex align-items-center ms-3">
          <!-- Search -->
          <div class="input-group me-3">
            <span class="input-group-text" id="search-icon">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              placeholder="Search sets..."
              aria-label="Search sets"
              id="search"
            />
            <button
              type="button"
              id="clear-search"
              aria-label="Clear search"
            >
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>

        <!-- Right-aligned items: Template dropdown & Generate PDF -->
        <div class="ms-auto d-flex align-items-center">
          <!-- Template Dropdown -->
          <div class="dropdown me-3">
            <button
              class="btn btn-secondary dropdown-toggle"
              type="button"
              id="templateDropdown"
              data-bs-toggle="dropdown"
              data-bs-boundary="viewport"
              data-bs-offset="0,8"
              aria-expanded="false"
            >
              <span id="templateDropdownText">Avery 5160/8460 (1" x 2-5/8")</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="templateDropdown" id="templateDropdownMenu">
              <li>
                <a class="dropdown-item template-option active" href="#" data-template="avery5160">
                  <strong>1" x 2-5/8"</strong>
                  <div class="small text-muted">Avery 5160/8460 (30/sheet)</div>
                </a>
              </li>
              <li>
                <a class="dropdown-item template-option" href="#" data-template="averyl7160">
                  <strong>63.5 x 38.1mm</strong>
                  <div class="small text-muted">Avery L7160 (21/sheet)</div>
                </a>
              </li>
              <li>
                <a class="dropdown-item template-option" href="#" data-template="avery64x30-r">
                  <strong>64 x 30mm</strong>
                  <div class="small text-muted">Avery 64x30-R (27/sheet)</div>
                </a>
              </li>
              <li>
                <a class="dropdown-item template-option" href="#" data-template="averyj8158">
                  <strong>64 x 26.7mm</strong>
                  <div class="small text-muted">Avery J8158 (30/sheet)</div>
                </a>
              </li>
              <li>
                <a class="dropdown-item template-option" href="#" data-template="averyl7157">
                  <strong>64 x 24.3mm</strong>
                  <div class="small text-muted">Avery L7157 (33/sheet)</div>
                </a>
              </li>
            </ul>
          </div>

          <!-- Debug Template Checkbox (only shown if feature flag is enabled) -->
          {% if enable_template_debug %}
          <div class="form-check me-3">
            <input
              class="form-check-input"
              type="checkbox"
              name="use_template"
              id="use-template-checkbox"
              form="sets-form"
            />
            <label class="form-check-label text-light" for="use-template-checkbox">
              Overlay on Template PDF
            </label>
          </div>
          {% endif %}

          <!-- Generate PDF button (submits #sets-form) - hidden on mobile -->
          <button
            type="submit"
            class="btn btn-primary d-none d-lg-inline-block"
            form="sets-form"
            id="desktop-generate-pdf"
          >
            <span class="btn-text">
              <i class="bi bi-file-earmark-pdf"></i> PDF
            </span>
          </button>
          <!-- Hidden input to store selected template (default will be set by JavaScript) -->
          <input type="hidden" name="template" id="selectedTemplate" value="" form="sets-form" />
        </div>
      </div>
    </div>
  </nav>

  <div class="container mt-2">
    <!-- <h1 class="mb-4 text-center">MTG Printable Label Generator</h1> -->

    <!-- Selection Counter at Top -->
    <div class="selection-counter-container">
      <div class="d-flex justify-content-between align-items-center gap-2">
        <div class="search-feedback" id="searchFeedback"></div>
        <div class="d-flex align-items-center gap-2 ms-auto">
          <span class="selection-counter empty" id="selectionCounter">
            <i class="bi bi-check2-square"></i>
            <span id="selectionCountText">0 sets</span>
          </span>
          <!-- Global Select All / Deselect All -->
          <button
            type="button"
            class="btn btn-secondary btn-sm"
            id="toggle-select-all-global"
          >
            <i class="bi bi-check-all"></i> Select All
          </button>
        </div>
      </div>
    </div>

    <!-- Accordion for grouped sets -->
    <form action="/generate-pdf" method="post" id="sets-form">
      {% for group, sets in grouped_sets.items() %}
      <div class="accordion" id="accordion-{{ group }}">
        <div class="accordion-item">
          <!--
            A parent container for the entire heading row (full width).
            We include the heading + "Select Group" button in one line.
          -->
          <div
            class="d-flex justify-content-between align-items-center w-100 px-2 py-2"
            id="heading-{{ group }}"
          >
            <!-- The heading itself -->
            <h2 class="accordion-header mb-0 flex-grow-1">
              <!-- The standard Bootstrap accordion button -->
              <button
                class="accordion-button collapsed text-start w-100"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapse-{{ group }}"
                aria-expanded="false"
                aria-controls="collapse-{{ group }}"
              >
                {{ group }}
              </button>
            </h2>

            <!-- Per-group toggle button (Select Group / Deselect Group) -->
            <button
              type="button"
              class="btn btn-sm btn-secondary toggle-group"
              data-group="#collapse-{{ group }}"
            >
              <i class="bi bi-check-all"></i> Select Group
            </button>
          </div>

          <!-- Collapsible content -->
          <div
            id="collapse-{{ group }}"
            class="accordion-collapse collapse"
            aria-labelledby="heading-{{ group }}"
            data-bs-parent="#accordion-{{ group }}"
          >
            <div class="accordion-body">
              <!-- Slightly tighter spacing between columns (g-1) -->
              <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-1">
                {% for set in sets %}
                <div class="col">
                  <div class="form-check set-item">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="set_ids"
                      value="{{ set.id }}"
                      id="set-{{ set.id }}"
                      data-type="{{ set.set_type }}"
                      {% if set.released_at %}
                      data-release="{{ set.released_at[:4] }}"
                      {% endif %}
                    />
                    <!--
                      Symbol on the LEFT, then the set name,
                      with full name in the "title" attribute for hover.
                    -->
                    <label
                      class="form-check-label truncate-label"
                      for="set-{{ set.id }}"
                      title="{{ set.name }}"
                    >
                      <img src="{{ set.icon_svg_uri }}" alt="symbol" />
                      {{ set.name }}
                    </label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </form>
  </div>

  <!-- Footer -->
  <footer class="py-4 bg-light border-top">
    <div class="container">
      <div class="row">
        <div class="col text-center">
          <p class="mb-2 small text-muted" style="line-height: 1.6;">
            MTG Printable Label Generator is unofficial Fan Content permitted under the Fan Content Policy. Not approved/endorsed by Wizards. Portions of the materials used are property of Wizards of the Coast. Â©Wizards of the Coast LLC.
          </p>
          <p class="mb-2 small text-muted" style="line-height: 1.6;">
            <a href="https://company.wizards.com/en/legal/fancontentpolicy" target="_blank" rel="noopener noreferrer" class="text-decoration-none">View the full Fan Content Policy</a>.
          </p>

          <p class="mb-0 small text-muted" style="line-height: 1.6;">
            It uses set information provided by <a href="https://scryfall.com/" target="_blank" rel="noopener noreferrer" class="text-decoration-none">Scryfall</a> in accordance with their <a href="https://scryfall.com/docs/api#use-of-scryfall-data" target="_blank" rel="noopener noreferrer" class="text-decoration-none">guidelines</a>.
          </p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Donate Modal -->
  <div class="modal fade" id="donateModal" tabindex="-1" aria-labelledby="donateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
      <div class="modal-content">
        <div class="modal-header border-bottom-0 pb-1 pt-3">
          <h5 class="modal-title fw-bold" id="donateModalLabel">Thank You!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-0 pb-2">
          <p class="text-center mb-3 lead">Your PDF is being generated. If you find this tool useful, consider supporting its development!</p>
          <div class="text-center mb-2">
            <form action="https://www.paypal.com/donate" method="post" target="_top" class="d-inline-block">
              <input type="hidden" name="business" value="3ABRQKUCLUGXN" />
              <input type="hidden" name="no_recurring" value="0" />
              <input type="hidden" name="item_name" value="for buying more MTG cards :)" />
              <input type="hidden" name="currency_code" value="USD" />
              <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
              <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const searchInput = document.getElementById("search");
      const clearButton = document.getElementById("clear-search");
      const globalToggleBtn = document.getElementById("toggle-select-all-global");
      const searchFeedback = document.getElementById("searchFeedback");
      const selectionCounter = document.getElementById("selectionCounter");
      const selectionCountText = document.getElementById("selectionCountText");
      const desktopPdfBtn = document.getElementById("desktop-generate-pdf");
      const mobilePdfBtn = document.getElementById("mobile-generate-pdf");

      // Store original button content for restoration
      const originalDesktopContent = desktopPdfBtn ? desktopPdfBtn.innerHTML : '';
      const originalMobileContent = mobilePdfBtn ? mobilePdfBtn.innerHTML : '';

      // ========== INITIALIZE TOOLTIPS ==========
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));

      // ========== THEME TOGGLE ==========
      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");

      function setTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);
        themeIcon.className = theme === "dark" ? "bi bi-sun-fill" : "bi bi-moon-fill";
      }

      function toggleTheme() {
        const current = document.documentElement.getAttribute("data-theme");
        setTheme(current === "dark" ? "light" : "dark");
      }

      // Load saved theme
      const savedTheme = localStorage.getItem("theme") ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
      setTheme(savedTheme);

      themeToggle.addEventListener("click", toggleTheme);

      // ========== SELECTION COUNTER ==========
      // Template to labels per page mapping (from backend config)
      const templateLabelsPerPage = {{ template_labels_per_page | tojson }} || {};

      function updateSelectionCounter() {
        const checkedCount = document.querySelectorAll('input[name="set_ids"]:checked').length;
        const selectedTemplate = document.getElementById("selectedTemplate").value || 'avery5160';
        const labelsPerPage = templateLabelsPerPage[selectedTemplate] || 30;
        const pageCount = checkedCount > 0 ? Math.ceil(checkedCount / labelsPerPage) : 0;

        let counterText = `${checkedCount} set${checkedCount !== 1 ? 's' : ''}`;
        if (pageCount > 0) {
          counterText += ` / ${pageCount} page${pageCount !== 1 ? 's' : ''}`;
        }

        selectionCountText.textContent = counterText;
        selectionCounter.classList.toggle("empty", checkedCount === 0);
      }

      // ========== GLOBAL SELECT ALL/DESELECT ALL ==========
      function updateGlobalToggleLabel() {
        const allCbs = document.querySelectorAll('input[type="checkbox"]');
        const anyUnchecked = Array.from(allCbs).some(cb => !cb.checked);
        globalToggleBtn.innerHTML = anyUnchecked
          ? '<i class="bi bi-check-all"></i> Select All'
          : '<i class="bi bi-x-circle"></i> Deselect All';
      }

      globalToggleBtn.addEventListener("click", function () {
        const allCbs = document.querySelectorAll('input[type="checkbox"]');
        const anyUnchecked = Array.from(allCbs).some(cb => !cb.checked);
        allCbs.forEach(cb => (cb.checked = anyUnchecked));
        saveGlobalSelections();
        updateGlobalToggleLabel();
        updateSelectionCounter();
        // Also update each group's button text
        document.querySelectorAll(".toggle-group").forEach(btn => {
          const groupSelector = btn.getAttribute("data-group");
          updateGroupToggleLabel(groupSelector, btn);
        });
        // Expand all groups when selecting all
        if (anyUnchecked) {
          document.querySelectorAll(".accordion-collapse").forEach(function (collapseElement) {
            let collapseInstance = bootstrap.Collapse.getInstance(collapseElement);
            if (!collapseInstance) {
              collapseInstance = new bootstrap.Collapse(collapseElement, { toggle: false });
            }
            collapseInstance.show();
          });
        }
      });

      // ========== GROUP TOGGLE (SELECT GROUP / DESELECT GROUP) ==========
      document.querySelectorAll(".toggle-group").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const groupSelector = this.getAttribute("data-group");
          const checkboxes = document.querySelectorAll(groupSelector + " input[type='checkbox']");
          const allChecked = Array.from(checkboxes).every(cb => cb.checked);
          checkboxes.forEach(cb => (cb.checked = !allChecked));
          saveGlobalSelections();
          updateGlobalToggleLabel();
          updateSelectionCounter();
          updateGroupToggleLabel(groupSelector, this);
          // Expand the group when selecting items
          if (!allChecked) {
            const collapseElement = document.querySelector(groupSelector);
            if (collapseElement) {
              let collapseInstance = bootstrap.Collapse.getInstance(collapseElement);
              if (!collapseInstance) {
                collapseInstance = new bootstrap.Collapse(collapseElement, { toggle: false });
              }
              collapseInstance.show();
            }
          }
        });
      });

      function updateGroupToggleLabel(groupSelector, button) {
        const checkboxes = document.querySelectorAll(groupSelector + " input[type='checkbox']");
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        button.innerHTML = allChecked
          ? '<i class="bi bi-x-circle"></i> Deselect Group'
          : '<i class="bi bi-check-all"></i> Select Group';
      }

      // ========== LOCAL STORAGE PERSISTENCE ==========
      function saveGlobalSelections() {
        const selected = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
          .map(cb => cb.value);
        localStorage.setItem("selectedSets", JSON.stringify(selected));
      }

      function loadGlobalSelections() {
        const stored = localStorage.getItem("selectedSets");
        if (stored) {
          const selected = JSON.parse(stored);
          document.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
            cb.checked = selected.includes(cb.value);
          });
        }
      }

      // ========== EXPAND GROUPS WITH SELECTED SETS ON LOAD ==========
      function expandGroupsWithSelectedSets() {
        const selected = JSON.parse(localStorage.getItem("selectedSets") || "[]");
        document.querySelectorAll(".accordion").forEach(function (accordion) {
          const collapseElement = accordion.querySelector(".accordion-collapse");
          let groupHasSelected = false;
          accordion.querySelectorAll("input[type='checkbox']").forEach(cb => {
            if (selected.includes(cb.value)) groupHasSelected = true;
          });
          if (groupHasSelected) {
            let collapseInstance = bootstrap.Collapse.getInstance(collapseElement);
            if (!collapseInstance) {
              collapseInstance = new bootstrap.Collapse(collapseElement, { toggle: false });
            }
            collapseInstance.show();
          }
          // Update the group toggle button text
          const toggleBtn = accordion.querySelector(".toggle-group");
          if (toggleBtn && collapseElement) {
            updateGroupToggleLabel("#" + collapseElement.id, toggleBtn);
          }
        });
      }

      // ========== CHECKBOX CHANGE HANDLER ==========
      document.querySelectorAll("input[type='checkbox']").forEach(function (cb) {
        cb.addEventListener("change", function () {
          saveGlobalSelections();
          updateGlobalToggleLabel();
          updateSelectionCounter();
          const parentAccordion = cb.closest(".accordion");
          if (parentAccordion) {
            const collapseElement = parentAccordion.querySelector(".accordion-collapse");
            const toggleBtn = parentAccordion.querySelector(".toggle-group");
            if (collapseElement && toggleBtn) {
              updateGroupToggleLabel("#" + collapseElement.id, toggleBtn);
            }
          }
        });
      });

      // ========== SEARCH FUNCTIONALITY ==========
      function toggleClearButton() {
        if (searchInput.value.trim()) {
          clearButton.classList.add("visible");
        } else {
          clearButton.classList.remove("visible");
        }
      }

      function updateSearchFeedback(message, isError = false) {
        if (searchFeedback) {
          searchFeedback.textContent = message;
          searchFeedback.classList.toggle("no-results", isError);
        }
      }

      function handleSearch() {
        const filter = searchInput.value.toLowerCase();
        let matchCount = 0;

        document.querySelectorAll(".accordion").forEach(function (accordion) {
          let groupHasMatch = false;
          accordion.querySelectorAll(".col").forEach(function (col) {
            const item = col.querySelector(".set-item");
            if (!item) return;
            const text = item.textContent.toLowerCase();
            const title = col.querySelector("label")?.getAttribute("title")?.toLowerCase() || "";
            if (text.indexOf(filter) > -1 || title.indexOf(filter) > -1) {
              col.style.display = "";
              groupHasMatch = true;
              matchCount++;
            } else {
              col.style.display = "none";
            }
          });
          const collapseElement = accordion.querySelector(".accordion-collapse");
          if (groupHasMatch) {
            let collapseInstance = bootstrap.Collapse.getInstance(collapseElement);
            if (!collapseInstance) {
              collapseInstance = new bootstrap.Collapse(collapseElement, { toggle: false });
            }
            collapseInstance.show();
            accordion.style.display = "";
          } else {
            let collapseInstance = bootstrap.Collapse.getInstance(collapseElement);
            if (collapseInstance) collapseInstance.hide();
            accordion.style.display = "none";
          }
        });

        // Update search feedback
        if (filter) {
          if (matchCount === 0) {
            updateSearchFeedback(`No sets found for "${filter}"`, true);
          } else {
            updateSearchFeedback(`${matchCount} set${matchCount !== 1 ? 's' : ''} found`, false);
          }
        } else {
          updateSearchFeedback("");
        }
      }

      function resetAccordionsToDefault() {
        document.querySelectorAll(".col").forEach(col => (col.style.display = ""));
        document.querySelectorAll(".accordion").forEach(function (accordion) {
          const collapseElem = accordion.querySelector(".accordion-collapse");
          let groupHasSelected = false;
          accordion.querySelectorAll("input[type='checkbox']").forEach(cb => {
            if (cb.checked) groupHasSelected = true;
          });
          let ci = bootstrap.Collapse.getInstance(collapseElem);
          if (!ci) {
            ci = new bootstrap.Collapse(collapseElem, { toggle: false });
          }
          groupHasSelected ? ci.show() : ci.hide();
          accordion.style.display = "";
        });
      }

      // ========== BUTTON LOADING STATE ==========
      function setButtonLoading(loading) {
        if (loading) {
          if (desktopPdfBtn) {
            desktopPdfBtn.classList.add("btn-loading");
            desktopPdfBtn.innerHTML = '<span class="btn-spinner"></span>';
          }
          if (mobilePdfBtn) {
            mobilePdfBtn.classList.add("btn-loading");
            mobilePdfBtn.innerHTML = '<span class="btn-spinner"></span>';
          }
        } else {
          if (desktopPdfBtn) {
            desktopPdfBtn.classList.remove("btn-loading");
            desktopPdfBtn.innerHTML = originalDesktopContent;
          }
          if (mobilePdfBtn) {
            mobilePdfBtn.classList.remove("btn-loading");
            mobilePdfBtn.innerHTML = originalMobileContent;
          }
        }
      }

      // ========== FORM SUBMISSION VALIDATION & LOADING STATE ==========
      const setsForm = document.getElementById("sets-form");
      const donateModal = new bootstrap.Modal(document.getElementById("donateModal"));

      setsForm.addEventListener("submit", async function (e) {
        const checkedBoxes = document.querySelectorAll('input[name="set_ids"]:checked');
        if (checkedBoxes.length === 0) {
          e.preventDefault();
          alert("Please select at least one set before generating the PDF.");
          return false;
        }

        // Prevent default form submission
        e.preventDefault();

        // Show loading spinner in button
        setButtonLoading(true);

        // Prepare form data
        const formData = new FormData(setsForm);

        try {
          // Submit form via fetch API
          const response = await fetch("/generate-pdf", {
            method: "POST",
            body: formData
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // Get the PDF blob
          const blob = await response.blob();

          // Create download link
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "mtg_labels.pdf";
          document.body.appendChild(a);
          a.click();

          // Cleanup
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          // Hide loading, show donate modal
          setButtonLoading(false);
          donateModal.show();
        } catch (error) {
          console.error("Error generating PDF:", error);
          setButtonLoading(false);
          alert("An error occurred while generating the PDF. Please try again.");
        }
      });

      // ========== TEMPLATE SELECTION ==========
      const templateDropdown = document.getElementById("templateDropdown");
      const templateDropdownText = document.getElementById("templateDropdownText");
      const selectedTemplateInput = document.getElementById("selectedTemplate");
      const templateOptions = document.querySelectorAll(".template-option");

      // Get default template from the first active option (or first option if none active)
      function getDefaultTemplate() {
        const activeOption = Array.from(templateOptions).find(opt => opt.classList.contains("active"));
        return activeOption
          ? activeOption.getAttribute("data-template")
          : templateOptions[0]?.getAttribute("data-template") || "avery5160";
      }

      // Helper function to get template label text from dropdown items
      function getTemplateLabel(templateId) {
        const option = Array.from(templateOptions).find(
          opt => opt.getAttribute("data-template") === templateId
        );
        return option ? option.textContent.trim() : "Select Template";
      }

      // Load saved template from localStorage
      function loadTemplateSelection() {
        const defaultTemplate = getDefaultTemplate();
        const savedTemplate = localStorage.getItem("selectedTemplate") || defaultTemplate;
        selectedTemplateInput.value = savedTemplate;
        templateDropdownText.textContent = getTemplateLabel(savedTemplate);

        // Update active state
        templateOptions.forEach(option => {
          if (option.getAttribute("data-template") === savedTemplate) {
            option.classList.add("active");
          } else {
            option.classList.remove("active");
          }
        });
      }

      // Handle template option clicks
      templateOptions.forEach(option => {
        option.addEventListener("click", function(e) {
          e.preventDefault();
          const template = this.getAttribute("data-template");
          selectedTemplateInput.value = template;
          templateDropdownText.textContent = this.textContent.trim();
          localStorage.setItem("selectedTemplate", template);

          // Update active state
          templateOptions.forEach(opt => opt.classList.remove("active"));
          this.classList.add("active");

          // Update selection counter to reflect new page count
          updateSelectionCounter();
        });
      });

      // ========== DROPDOWN POSITIONING ==========
      const templateDropdownElement = document.getElementById("templateDropdown");
      const templateDropdownMenu = document.getElementById("templateDropdownMenu");

      // Ensure dropdown stays within viewport
      if (templateDropdownElement && templateDropdownMenu) {
        templateDropdownElement.addEventListener("shown.bs.dropdown", function () {
          const rect = templateDropdownMenu.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;

          // Check if dropdown overflows right edge
          if (rect.right > viewportWidth) {
            templateDropdownMenu.style.right = "0";
            templateDropdownMenu.style.left = "auto";
            templateDropdownMenu.style.transform = "translateX(0)";
          }

          // Check if dropdown overflows bottom edge
          if (rect.bottom > viewportHeight) {
            templateDropdownMenu.style.bottom = "100%";
            templateDropdownMenu.style.top = "auto";
            templateDropdownMenu.style.marginBottom = "0.5rem";
            templateDropdownMenu.style.marginTop = "0";
          } else {
            templateDropdownMenu.style.top = "100%";
            templateDropdownMenu.style.bottom = "auto";
            templateDropdownMenu.style.marginTop = "0.5rem";
            templateDropdownMenu.style.marginBottom = "0";
          }
        });

        // Reset positioning when dropdown is hidden
        templateDropdownElement.addEventListener("hidden.bs.dropdown", function () {
          templateDropdownMenu.style.transform = "";
        });
      }

      // ========== ON PAGE LOAD ==========
      loadTemplateSelection();
      loadGlobalSelections();
      updateGlobalToggleLabel();
      updateSelectionCounter();
      expandGroupsWithSelectedSets();

      // Hook up search + clear button
      toggleClearButton();
      searchInput.addEventListener("input", function () {
        toggleClearButton();
        if (searchInput.value.trim() === "") {
          resetAccordionsToDefault();
          updateSearchFeedback("");
        } else {
          handleSearch();
        }
      });
      clearButton.addEventListener("click", function () {
        searchInput.value = "";
        toggleClearButton();
        resetAccordionsToDefault();
        updateSearchFeedback("");
      });
    });
  </script>
</body>
</html>
